\documentclass[black,white,aspectratio=169]{beamer}
\usepackage{beamerthemesplit}
\usepackage{amsmath}
\usepackage{adjustbox}
\usepackage{bookmark}
\usepackage{courier}
\usepackage[T1]{fontenc}
\usepackage{hyperref}
\usepackage[utf8]{inputenc}
\usepackage{listings}
\usepackage{lmodern}
\usepackage{tikz}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{lmodern}
\usepackage{pifont}
\usepackage{subcaption}
\usepackage{svg} % Requires inkscape
\usepackage{tabularx}
\usepackage{tikz}
\usetikzlibrary{mindmap}
\usepackage{verbatim}
\usepackage{xcolor}
\usepackage{yaml}

\beamertemplatenavigationsymbolsempty
\usecolortheme{dove}
\useoutertheme{infolines}
\useinnertheme{rectangles}

\setbeamersize{text margin left=32pt,text margin right=32pt}

\newcommand{\cmark}{\ding{51}}%
\newcommand{\bigcmark}{{\large\textcolor{green}\cmark}}
\newcommand{\xmark}{\ding{55}}
\newcommand{\bigxmark}{{\large\textcolor{red}\xmark}}
\newcommand\blfootnote[1]{%
  \begingroup
  \renewcommand\thefootnote{}\footnote{#1}%
  \addtocounter{footnote}{-1}%
  \endgroup
}

\definecolor{ashgrey}{rgb}{0.7,0.75,0.71}
\definecolor{charcoal}{rgb}{0.21,0.27,0.31}
\definecolor{powderblue}{rgb}{0.69,0.88,0.9}
\definecolor{layerblue}{RGB}{213,234,254}
\definecolor{lpcyellow}{RGB}{246,243,234}
\newcommand\sectioncolor{\setbeamercolor{background canvas}{bg=lpcyellow}}

\setbeamertemplate{background canvas}[default]
\setbeamercolor{background canvas}{bg=lpcyellow}

% Align hash to font
\let\oldhash\#%
\DeclareRobustCommand{\#}{\adjustbox{valign=B,totalheight=.57\baselineskip}{\oldhash}}%

\newcommand{\link}[1]{{\large\color{blue}\href{#1}{#1}}}

% Support backup slides with their own numbering scheme
\newcommand{\backupbegin}{
   \newcounter{finalframe}
   \setcounter{finalframe}{\value{framenumber}}
}
\newcommand{\backupend}{
   \setcounter{framenumber}{\value{finalframe}}
}

\title[Packet mark in a Cloud Native world]{Packet mark in a Cloud Native world}
\institute{Cilium.io}
\author[Joe Stringer]{Joe Stringer}

\setbeamertemplate{headline}
{
    \leavevmode%
    \hbox{%
        \begin{beamercolorbox}[wd=\paperwidth,ht=2.25ex,dp=1ex,center]{}
            \insertsection
        \end{beamercolorbox}
    }
    \vskip0pt
}
\setbeamertemplate{footline}
{
    \leavevmode%
    \hbox{%
        \begin{beamercolorbox}[wd=.333333\paperwidth,ht=2.25ex,dp=1ex,left]{}%
            \usebeamerfont{date in head/foot}\hspace*{2ex}\insertshortdate{}
        \end{beamercolorbox}%
        \begin{beamercolorbox}[wd=.333333\paperwidth,ht=2.25ex,dp=1ex,center]{}%
            \usebeamerfont{title in head/foot}\insertshorttitle
        \end{beamercolorbox}%
        \begin{beamercolorbox}[wd=.333333\paperwidth,ht=2.25ex,dp=1ex,right]{}%
            \insertframenumber{} / \inserttotalframenumber\hspace*{2ex}
        \end{beamercolorbox}}%
        \vskip0pt%
}

\newcommand\newsectionpage[1]{
    \section{#1}
    {\sectioncolor
        \begin{frame}[plain]
            \vfill
            \centering
            \begin{beamercolorbox}[sep=8pt,center,shadow=true,rounded=true]{title}
                \usebeamerfont{title}\insertsectionhead\par%
            \end{beamercolorbox}
            \vfill
        \end{frame}
    }
}

\newcommand\suspense{
    \pause $\rightarrow$
}

\newcommand\todo[1]{
    \textcolor{red}{#1}
}

\date[August 24, 2020]{}

\begin{document}
    \section*{Introduction}
    {
        \usebackgroundtemplate%
        {%
          \includegraphics[width=\paperwidth,height=\paperheight]{background.jpg}%
        }
        \begin{frame}[plain]
            \vspace*{8ex}
            \titlepage
        \end{frame}
    }

    \begin{frame}{Overview}
        \tableofcontents
    \end{frame}

    \section{Background}

    \begin{frame}[fragile]{In the beginning...}
        \begin{itemize}
            \item There was the \verb+skb->mark+. And it was good. \bigskip
        \end{itemize}
    \end{frame}

    \begin{frame}[fragile]{A brief history}
        \begin{itemize}
            \item \verb+fwmark+ \bigskip
            \item \verb+pkt_mark+ \bigskip
            \item \verb+ctmark+ \bigskip
            \item \verb+SO_MARK+ \bigskip
        \end{itemize}
    \end{frame}

    \begin{frame}{Cloud Native networking}
        \begin{figure}
            \includegraphics[width=\textwidth]{plugins.png}
        \end{figure}
    \end{frame}

    \newsectionpage{Use cases}

    \begin{frame}{Multi-homing}
        \todo{aws-vpc-cni-k8s / Cilium}
    \end{frame}

    \begin{frame}{Application identity}
        \todo{Cilium mark transfer}
    \end{frame}

    \begin{frame}{Network policy}
        \todo{Include iptables match+mark -> ... -> drop}
        \todo{Varies - mark if allowed or mark if denied.}
    \end{frame}

    \begin{frame}{IP masquerade}
        \todo{Typically 1 bit "apply masquerade to this traffic". Occasionally more.}
        % Notable exception: OpenShift "egress traffic from this entity with external IP ___" -> full IP into mark.
    \end{frame}

    \begin{frame}{Exposing services}
        \todo{HostPort / ExternalIPs / NodePort features}
    \end{frame}

    \begin{frame}{Service proxy}
        \todo{Cilium, Istio, AWS-appmesh}
    \end{frame}

    \begin{frame}{Transparent encryption}
        \todo{Cilium, Weave}
    \end{frame}

    \newsectionpage{Common themes}

    \begin{frame}{System control}
        \todo{Bitwise}
        \todo{Full-mark}
    \end{frame}

    \begin{frame}{Internal state tracking}
        \todo{Can be either within a subsystem or across subsystem components
              programmed by the same application}
    \end{frame}

    \newsectionpage{Avoiding conflicts via eBPF}

    \begin{frame}{Evaluate interoperability}
        \todo{Eg most of these software must work with k8s. Default configuration
              makes BIT 15 -> Drop.} \bigskip
        \todo{Scope changes depending on how ambitious you are. Cilium aims to
              allow swapping in/out routing / service layers.
              Means that when you run alternative implementation, there must be
              co-ordination.} \bigskip
    \end{frame}

    \begin{frame}{Consolidate on fewer APIs}
        \todo{Building a more cohesive dataplane in the most flexible way we can: eBPF}
    \end{frame}

    \begin{frame}[fragile]{Internal state transfer: Control block}
        \todo{skb->cb for transferring information internally.}
    \end{frame}

    \begin{frame}{Purpose-built subsystem co-ordination}
        \begin{itemize}
            \item \todo{tproxy eBPF - saved 16 bits of 32-bit mark} \bigskip
            \item \todo{floated - eBPF/xfrm} \bigskip
        \end{itemize}
    \end{frame}

    \begin{frame}{Dynamic extension of metadata}
        \todo{CONFIG\_SKB\_EXTENSIONS}
    \end{frame}

    \section*{Prologue}
    \begin{frame}{Summary}
        \begin{itemize}
            \item Point 1
        \end{itemize}
    \end{frame}

    \begin{frame}{Thank you}
        \centering
        \vfill
        \begin{table}
            \begin{subtable}[l]{0.6\textwidth}
                \begin{tabular}{rl}
                    \multicolumn{2}{l}{\textbf{More information}} \\ \\
                    \includesvg[width=0.045\textwidth]{www.svg}
                    & \link{https://cilium.io} \\
                    \includesvg[width=0.045\textwidth]{slack.svg}
                    & \link{https://cilium.io/slack} \\
                    \includesvg[width=0.045\textwidth]{github.svg}
                    & \link{https://github.com/cilium/cilium} \\
                    \includesvg[width=0.045\textwidth]{twitter.svg}
                    & \link{https://twitter.com/ciliumproject} \\
                \end{tabular}
            \end{subtable}
            \begin{subtable}[r]{0.35\textwidth}
                \includesvg[width=0.9\textwidth]{cilium-gopher.svg}
            \end{subtable}
        \end{table}
        \pause
        \vfill
    \end{frame}

    \appendix
    \backupbegin

    \section*{Appendix}
    \begin{frame}{Backup Slide}
    \end{frame}

    \backupend

\end{document}
